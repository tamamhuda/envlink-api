FROM node:22-slim AS base

# Enable pnpm (via corepack)
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

# Install required system packages
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        openssl \
        libssl-dev \
        libpq-dev \
        postgresql-client && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install dependencies using pnpm with cache mount
FROM base AS deps
COPY package*.json pnpm-lock.yaml ./
RUN --mount=type=cache,id=pnpm-store,target=/pnpm/store \
    pnpm install --frozen-lockfile

# Runtime + dev environment
FROM base AS dev
COPY --from=deps /app/node_modules /app/node_modules

COPY . .

# Install playwright with dependencies
RUN pnpm exec playwright install --with-deps --only-shell

# init script
COPY entrypoint.dev.sh /app/entrypoint.dev.sh
RUN chmod +x /app/entrypoint.dev.sh

CMD ["/app/entrypoint.dev.sh"]
